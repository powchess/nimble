#include <stdlib.h>
#include <stdio.h>
#include <stdint.h>
#include <math.h>
#include <time.h>
#include "secp256k1.h"
#include "ecdsa.h"

extern bn_digit_t* g_pt_G;
extern bn_digit_t* g_bn_P;

#define expect(x) if (!(x)) { exit(1); }

#if DIGIT_SIZE == 8
// KygjPimDDsirZyPETarSThAjsUDSuV52oSJQYNkA71DiNwzEF8pi
// 499348d484c10820fe179cd04ce305df11c0fcd1eed6763830e5c82eff07e6a1
const bn_t BN_PRIVKEY = {
    0xa1, 0xe6, 0x07, 0xff, 0x2e, 0xc8, 0xe5, 0x30, 0x38, 0x76, 0xd6, 0xee, 0xd1, 0xfc, 0xc0, 0x11,
    0xdf, 0x05, 0xe3, 0x4c, 0xd0, 0x9c, 0x17, 0xfe, 0x20, 0x08, 0xc1, 0x84, 0xd4, 0x48, 0x93, 0x49,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x20, 0x00
};

// 843bb6879ba27ee94aa6e8f02ccbf034e9e21b11e19243d6e694a2a490b227c7
const bn_t BN_PUBKEYX = {
    0xc7, 0x27, 0xb2, 0x90, 0xa4, 0xa2, 0x94, 0xe6, 0xd6, 0x43, 0x92, 0xe1, 0x11, 0x1b, 0xe2, 0xe9,
    0x34, 0xf0, 0xcb, 0x2c, 0xf0, 0xe8, 0xa6, 0x4a, 0xe9, 0x7e, 0xa2, 0x9b, 0x87, 0xb6, 0x3b, 0x84,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x20, 0x00
};

// 98ce76cd6b6a347e35c45ce88c12103ba9ca7643f4cb2b687cd94b424c4483d3
const bn_t BN_PUBKEYY = {
    0xd3, 0x83, 0x44, 0x4c, 0x42, 0x4b, 0xd9, 0x7c, 0x68, 0x2b, 0xcb, 0xf4, 0x43, 0x76, 0xca, 0xa9,
    0x3b, 0x10, 0x12, 0x8c, 0xe8, 0x5c, 0xc4, 0x35, 0x7e, 0x34, 0x6a, 0x6b, 0xcd, 0x76, 0xce, 0x98,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x20, 0x00
};
#endif

#if DIGIT_SIZE == 32
// KygjPimDDsirZyPETarSThAjsUDSuV52oSJQYNkA71DiNwzEF8pi
// 499348d484c10820fe179cd04ce305df11c0fcd1eed6763830e5c82eff07e6a1
const bn_t BN_PRIVKEY = {
    0xff07e6a1, 0x30e5c82e, 0xeed67638, 0x11c0fcd1, 0x4ce305df, 0xfe179cd0, 0x84c10820, 0x499348d4,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000008, 0x00000000,
};

// 843bb6879ba27ee94aa6e8f02ccbf034e9e21b11e19243d6e694a2a490b227c7
const bn_t BN_PUBKEYX = {
    0x90b227c7, 0xe694a2a4, 0xe19243d6, 0xe9e21b11, 0x2ccbf034, 0x4aa6e8f0, 0x9ba27ee9, 0x843bb687,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000008, 0x00000000,
};

// 98ce76cd6b6a347e35c45ce88c12103ba9ca7643f4cb2b687cd94b424c4483d3
const bn_t BN_PUBKEYY = {
    0x4c4483d3, 0x7cd94b42, 0xf4cb2b68, 0xa9ca7643, 0x8c12103b, 0x35c45ce8, 0x6b6a347e, 0x98ce76cd,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000008, 0x00000000,
};

// a93f6abc36ed64f92eef78af7bc12703fb577fc161e648126f0c96eb3b680365
const bn_t BN_PRIVKEY2 = {
    0x3b680365, 0x6f0c96eb, 0x61e64812, 0xfb577fc1, 0x7bc12703, 0x2eef78af, 0x36ed64f9, 0xa93f6abc,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000008, 0x00000000,
};

// cd4bf2ae443162719e7fc92d7b083ca7f9f67993e776dafe4f97917a55ad40fb
const bn_t BN_PUBKEYX2 = {
    0x55AD40FB, 0x4F97917A, 0xE776DAFE, 0xF9F67993, 0x7B083CA7, 0x9E7FC92D, 0x44316271, 0xCD4BF2AE,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000008, 0x00000000,
};

// c7a69ef3e0d89a8d4dc755b5cfb7eb540ce9cc88567642f000bcec9ad3236daf
const bn_t BN_PUBKEYY2 = {
    0xd3236daf, 0x00bcec9a, 0x567642f0, 0x0ce9cc88, 0xcfb7eb54, 0x4dc755b5, 0xe0d89a8d, 0xc7a69ef3,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000008, 0x00000000,
};

// d5a473ea57f792912ee63c63d83f32eefad976e31bd18bcaf7ec2473c1cc0ca9
const bn_t BN_PRIVKEY3 = {
    0xc1cc0ca9, 0xf7ec2473, 0x1bd18bca, 0xfad976e3, 0xd83f32ee, 0x2ee63c63, 0x57f79291, 0xd5a473ea,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000008, 0x00000000,
};

// f3eb0cfaccb3eddfba38405b02a7e1ddad9054bd64a7342b1ece46bf067ed53b
const bn_t BN_PUBKEYX3 = {
    0x067ed53b, 0x1ece46bf, 0x64a7342b, 0xad9054bd, 0x02a7e1dd, 0xba38405b, 0xccb3eddf, 0xf3eb0cfa,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000008, 0x00000000,
};

// 9a72f42c876fdcebb2cea2c93299fb5491c18fa942e2a1064972586635c73fac
const bn_t BN_PUBKEYY3 = {
    0x35c73fac, 0x49725866, 0x42e2a106, 0x91c18fa9, 0x3299fb54, 0xb2cea2c9, 0x876fdceb, 0x9a72f42c,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000008, 0x00000000,
};
#endif

#if DIGIT_SIZE == 64
// KygjPimDDsirZyPETarSThAjsUDSuV52oSJQYNkA71DiNwzEF8pi
// 499348d484c10820fe179cd04ce305df11c0fcd1eed6763830e5c82eff07e6a1
const bn_t BN_PRIVKEY = {
    0x30e5c82eff07e6a1, 0x11c0fcd1eed67638, 0xfe179cd04ce305df, 0x499348d484c10820,
    0x0000000000000000, 0x0000000000000000, 0x0000000000000000, 0x0000000000000000,
    0x0000000000000000, 0x0000000000000000, 0x0000000000000000, 0x0000000000000000,
    0x0000000000000000, 0x0000000000000000, 0x0000000000000000, 0x0000000000000000,
    0x0000000000000000, 0x0000000000000000, 0x0000000000000000, 0x0000000000000000,
    0x0000000000000000, 0x0000000000000000, 0x0000000000000000, 0x0000000000000000,
    0x0000000000000000, 0x0000000000000000, 0x0000000000000000, 0x0000000000000000,
    0x0000000000000000, 0x0000000000000000, 0x0000000000000004, 0x0000000000000000,
};

// 843bb6879ba27ee94aa6e8f02ccbf034e9e21b11e19243d6e694a2a490b227c7
const bn_t BN_PUBKEYX = {
    0xe694a2a490b227c7, 0xe9e21b11e19243d6, 0x4aa6e8f02ccbf034, 0x843bb6879ba27ee9,
    0x0000000000000000, 0x0000000000000000, 0x0000000000000000, 0x0000000000000000,
    0x0000000000000000, 0x0000000000000000, 0x0000000000000000, 0x0000000000000000,
    0x0000000000000000, 0x0000000000000000, 0x0000000000000000, 0x0000000000000000,
    0x0000000000000000, 0x0000000000000000, 0x0000000000000000, 0x0000000000000000,
    0x0000000000000000, 0x0000000000000000, 0x0000000000000000, 0x0000000000000000,
    0x0000000000000000, 0x0000000000000000, 0x0000000000000000, 0x0000000000000000,
    0x0000000000000000, 0x0000000000000000, 0x0000000000000004, 0x0000000000000000,
};

// 98ce76cd6b6a347e35c45ce88c12103ba9ca7643f4cb2b687cd94b424c4483d3
const bn_t BN_PUBKEYY = {
    0x7cd94b424c4483d3, 0xa9ca7643f4cb2b68, 0x35c45ce88c12103b, 0x98ce76cd6b6a347e,
    0x0000000000000000, 0x0000000000000000, 0x0000000000000000, 0x0000000000000000,
    0x0000000000000000, 0x0000000000000000, 0x0000000000000000, 0x0000000000000000,
    0x0000000000000000, 0x0000000000000000, 0x0000000000000000, 0x0000000000000000,
    0x0000000000000000, 0x0000000000000000, 0x0000000000000000, 0x0000000000000000,
    0x0000000000000000, 0x0000000000000000, 0x0000000000000000, 0x0000000000000000,
    0x0000000000000000, 0x0000000000000000, 0x0000000000000000, 0x0000000000000000,
    0x0000000000000000, 0x0000000000000000, 0x0000000000000004, 0x0000000000000000,
};

// a93f6abc36ed64f92eef78af7bc12703fb577fc161e648126f0c96eb3b680365
const bn_t BN_PRIVKEY2 = {
    0x6f0c96eb3b680365, 0xfb577fc161e64812, 0x2eef78af7bc12703, 0xa93f6abc36ed64f9,
    0x0000000000000000, 0x0000000000000000, 0x0000000000000000, 0x0000000000000000,
    0x0000000000000000, 0x0000000000000000, 0x0000000000000000, 0x0000000000000000,
    0x0000000000000000, 0x0000000000000000, 0x0000000000000000, 0x0000000000000000,
    0x0000000000000000, 0x0000000000000000, 0x0000000000000000, 0x0000000000000000,
    0x0000000000000000, 0x0000000000000000, 0x0000000000000000, 0x0000000000000000,
    0x0000000000000000, 0x0000000000000000, 0x0000000000000000, 0x0000000000000000,
    0x0000000000000000, 0x0000000000000000, 0x0000000000000004, 0x0000000000000000,
};

// cd4bf2ae443162719e7fc92d7b083ca7f9f67993e776dafe4f97917a55ad40fb
const bn_t BN_PUBKEYX2 = {
    0x4F97917A55AD40FB, 0xF9F67993E776DAFE, 0x9E7FC92D7B083CA7, 0xCD4BF2AE44316271,
    0x0000000000000000, 0x0000000000000000, 0x0000000000000000, 0x0000000000000000,
    0x0000000000000000, 0x0000000000000000, 0x0000000000000000, 0x0000000000000000,
    0x0000000000000000, 0x0000000000000000, 0x0000000000000000, 0x0000000000000000,
    0x0000000000000000, 0x0000000000000000, 0x0000000000000000, 0x0000000000000000,
    0x0000000000000000, 0x0000000000000000, 0x0000000000000000, 0x0000000000000000,
    0x0000000000000000, 0x0000000000000000, 0x0000000000000000, 0x0000000000000000,
    0x0000000000000000, 0x0000000000000000, 0x0000000000000004, 0x0000000000000000,
};

// c7a69ef3e0d89a8d4dc755b5cfb7eb540ce9cc88567642f000bcec9ad3236daf
const bn_t BN_PUBKEYY2 = {
    0x00bcec9ad3236daf, 0x0ce9cc88567642f0, 0x4dc755b5cfb7eb54, 0xc7a69ef3e0d89a8d,
    0x0000000000000000, 0x0000000000000000, 0x0000000000000000, 0x0000000000000000,
    0x0000000000000000, 0x0000000000000000, 0x0000000000000000, 0x0000000000000000,
    0x0000000000000000, 0x0000000000000000, 0x0000000000000000, 0x0000000000000000,
    0x0000000000000000, 0x0000000000000000, 0x0000000000000000, 0x0000000000000000,
    0x0000000000000000, 0x0000000000000000, 0x0000000000000000, 0x0000000000000000,
    0x0000000000000000, 0x0000000000000000, 0x0000000000000000, 0x0000000000000000,
    0x0000000000000000, 0x0000000000000000, 0x0000000000000004, 0x0000000000000000,
};

// d5a473ea57f792912ee63c63d83f32eefad976e31bd18bcaf7ec2473c1cc0ca9
const bn_t BN_PRIVKEY3 = {
    0xf7ec2473c1cc0ca9, 0xfad976e31bd18bca, 0x2ee63c63d83f32ee, 0xd5a473ea57f79291,
    0x0000000000000000, 0x0000000000000000, 0x0000000000000000, 0x0000000000000000,
    0x0000000000000000, 0x0000000000000000, 0x0000000000000000, 0x0000000000000000,
    0x0000000000000000, 0x0000000000000000, 0x0000000000000000, 0x0000000000000000,
    0x0000000000000000, 0x0000000000000000, 0x0000000000000000, 0x0000000000000000,
    0x0000000000000000, 0x0000000000000000, 0x0000000000000000, 0x0000000000000000,
    0x0000000000000000, 0x0000000000000000, 0x0000000000000000, 0x0000000000000000,
    0x0000000000000000, 0x0000000000000000, 0x0000000000000004, 0x0000000000000000,
};

// f3eb0cfaccb3eddfba38405b02a7e1ddad9054bd64a7342b1ece46bf067ed53b
const bn_t BN_PUBKEYX3 = {
    0x1ece46bf067ed53b, 0xad9054bd64a7342b, 0xba38405b02a7e1dd, 0xf3eb0cfaccb3eddf,
    0x0000000000000000, 0x0000000000000000, 0x0000000000000000, 0x0000000000000000,
    0x0000000000000000, 0x0000000000000000, 0x0000000000000000, 0x0000000000000000,
    0x0000000000000000, 0x0000000000000000, 0x0000000000000000, 0x0000000000000000,
    0x0000000000000000, 0x0000000000000000, 0x0000000000000000, 0x0000000000000000,
    0x0000000000000000, 0x0000000000000000, 0x0000000000000000, 0x0000000000000000,
    0x0000000000000000, 0x0000000000000000, 0x0000000000000000, 0x0000000000000000,
    0x0000000000000000, 0x0000000000000000, 0x0000000000000004, 0x0000000000000000,
};

// 9a72f42c876fdcebb2cea2c93299fb5491c18fa942e2a1064972586635c73fac
const bn_t BN_PUBKEYY3 = {
    0x4972586635c73fac, 0x91c18fa942e2a106, 0xb2cea2c93299fb54, 0x9a72f42c876fdceb,
    0x0000000000000000, 0x0000000000000000, 0x0000000000000000, 0x0000000000000000,
    0x0000000000000000, 0x0000000000000000, 0x0000000000000000, 0x0000000000000000,
    0x0000000000000000, 0x0000000000000000, 0x0000000000000000, 0x0000000000000000,
    0x0000000000000000, 0x0000000000000000, 0x0000000000000000, 0x0000000000000000,
    0x0000000000000000, 0x0000000000000000, 0x0000000000000000, 0x0000000000000000,
    0x0000000000000000, 0x0000000000000000, 0x0000000000000000, 0x0000000000000000,
    0x0000000000000000, 0x0000000000000000, 0x0000000000000004, 0x0000000000000000,
};
#endif

int secs_since(const struct timespec* start) {
    struct timespec now;
    clock_gettime(CLOCK_REALTIME, &now);
    return (((__int128_t)now.tv_sec - (__int128_t)start->tv_sec) * 1000000000 + ((__int128_t)now.tv_nsec - (__int128_t)start->tv_nsec)) / 1000000000;
}

int main() {
    srand(time(0));

    long count, duration = 1;
    struct timespec start;

    printf("secp256k1_init\n");
    count = 0;
    clock_gettime(CLOCK_REALTIME, &start);
    unsigned long memory_start = (unsigned long)malloc(BN_LEN * 10000);
    while (secs_since(&start) < duration) {
        secp256k1_init(memory_start);
        count++;
    }
    printf("Avg time: %f ms\n", duration * 1000.0 / count);
    ecdsa_init(memory_start);

    printf("pt_mul: gen pubkey\n");
    pt_t pt_a;
    count = 0;
    clock_gettime(CLOCK_REALTIME, &start);
    while (secs_since(&start) < duration) {
        pt_mul(pt_a, g_pt_G, BN_PRIVKEY);
        count++;
    }
    printf("Avg time: %f ms\n", duration * 1000.0 / count);
    for (int i = 0; i < bn_len(pt_a); i++) {
        expect(pt_x(pt_a)[i] == BN_PUBKEYX[i]);
        expect(pt_y(pt_a)[i] == BN_PUBKEYY[i]);
    }

    printf("pt_mul: gen pubkey2\n");
    pt_mul(pt_a, g_pt_G, BN_PRIVKEY2);
    for (int i = 0; i < bn_len(pt_a); i++) {
        expect(pt_x(pt_a)[i] == BN_PUBKEYX2[i]);
        expect(pt_y(pt_a)[i] == BN_PUBKEYY2[i]);
    }

    printf("pt_mul: gen pubkey3\n");
    pt_mul(pt_a, g_pt_G, BN_PRIVKEY3);
    for (int i = 0; i < bn_len(pt_a); i++) {
        expect(pt_x(pt_a)[i] == BN_PUBKEYX3[i]);
        expect(pt_y(pt_a)[i] == BN_PUBKEYY3[i]);
    }

    printf("g_mul: gen pubkey\n");
    count = 0;
    clock_gettime(CLOCK_REALTIME, &start);
    while (secs_since(&start) < duration) {
        g_mul(pt_a, BN_PRIVKEY);
        count++;
    }
    printf("Avg time: %f ms\n", duration * 1000.0 / count);
    for (int i = 0; i < bn_len(pt_a); i++) {
        expect(pt_x(pt_a)[i] == BN_PUBKEYX[i]);
        expect(pt_y(pt_a)[i] == BN_PUBKEYY[i]);
    }

    printf("g_mul: gen pubkey2\n");
    g_mul(pt_a, BN_PRIVKEY2);
    for (int i = 0; i < bn_len(pt_a); i++) {
        expect(pt_x(pt_a)[i] == BN_PUBKEYX2[i]);
        expect(pt_y(pt_a)[i] == BN_PUBKEYY2[i]);
    }

    printf("g_mul: gen pubkey3\n");
    g_mul(pt_a, BN_PRIVKEY3);
    for (int i = 0; i < bn_len(pt_a); i++) {
        expect(pt_x(pt_a)[i] == BN_PUBKEYX3[i]);
        expect(pt_y(pt_a)[i] == BN_PUBKEYY3[i]);
    }

    printf("decompress_y: from pubkey x\n");
    bn_t bn_y;
    count = 0;
    clock_gettime(CLOCK_REALTIME, &start);
    while (secs_since(&start) < duration) {
        decompress_y(bn_y, BN_PUBKEYX, bn_num(BN_PUBKEYY)[0] & 0x01 ? 0x03 : 0x02);
        count++;
    }
    printf("Avg time: %f ms\n", duration * 1000.0 / count);
    for (int i = 0; i < bn_len(bn_y); i++) {
        expect(bn_num(bn_y)[i] == BN_PUBKEYY[i]);
    }

    printf("decompress_y: from pubkey2 x\n");
    decompress_y(bn_y, BN_PUBKEYX2, bn_num(BN_PUBKEYY2)[0] & 0x01 ? 0x03 : 0x02);
    for (int i = 0; i < bn_len(bn_y); i++) {
        expect(bn_num(bn_y)[i] == BN_PUBKEYY2[i]);
    }

    printf("decompress_y: from pubkey3 x\n");
    decompress_y(bn_y, BN_PUBKEYX3, bn_num(BN_PUBKEYY3)[0] & 0x01 ? 0x03 : 0x02);
    for (int i = 0; i < bn_len(bn_y); i++) {
        expect(bn_num(bn_y)[i] == BN_PUBKEYY3[i]);
    }

    printf("validate_point: valid\n");
    pt_t pt;
    copy_bn(pt_x(pt), BN_PUBKEYX);
    copy_bn(pt_y(pt), BN_PUBKEYY);
    expect(validate_point(pt) == 0);

    printf("validate_point: not on curve\n");
    copy_bn(pt_x(pt), BN_PUBKEYX2);
    copy_bn(pt_y(pt), BN_PUBKEYX3);
    expect(validate_point(pt) != 0);

    printf("validate_point: identity point\n");
    bn_from_digit(pt_x(pt), 0);
    bn_from_digit(pt_y(pt), 0);
    expect(validate_point(pt) != 0);

    printf("validate_point: negative x\n");
    copy_bn(pt_x(pt), BN_PUBKEYX);
    copy_bn(pt_y(pt), BN_PUBKEYY);
    bn_sub(pt_x(pt), pt_x(pt), g_bn_P);
    expect(validate_point(pt) != 0);

    printf("validate_point: monte carlo 1K\n");
    bn_t privkeys[1000];
    pt_t pubkeys[1000];
    for (int i = 0; i < 1000; i++) {
        int64_t r = rand() % RAND_MAX / 2 + RAND_MAX / 2;
        bn_from_int(privkeys[i], r);
        g_mul(pubkeys[i], privkeys[i]);
    }
    clock_gettime(CLOCK_REALTIME, &start);
    for (int i = 0; i < 1000; i++) {
        expect(validate_point(pubkeys[i]) == 0)
    }
    printf("Avg time: %f ms\n", (secs_since(&start)) * 1000.0 / 1000);

    printf("ecdsa_sign and ecdsa_verify\n");
    bn_t r, s, k, hash32;
    pt_t pubkey;
    copy_bn(hash32, BN_PUBKEYX);
    copy_bn(k, BN_PRIVKEY);
    copy_bn(pubkey, BN_PUBKEYX3);
    copy_bn(pubkey + BN_LEN, BN_PUBKEYY3);
    expect(!ecdsa_sign(r, s, hash32, k, BN_PRIVKEY3, pubkey));
    expect(!ecdsa_verify(r, s, hash32, pubkey));

    printf("ecdsa_sign: monte carlo 1K\n");
    bn_t ks[1000];
    bn_t rs[1000];
    bn_t ss[1000];
    for (int i = 0; i < 1000; i++) {
        int64_t r = rand() % RAND_MAX / 2 + RAND_MAX / 2;
        bn_from_int(ks[i], r);
    }
    clock_gettime(CLOCK_REALTIME, &start);
    for (int i = 0; i < 1000; i++) {
        expect(!ecdsa_sign(rs[i], ss[i], hash32, ks[i], privkeys[i], pubkeys[i]));
    }
    printf("Avg time: %f ms\n", (secs_since(&start)) * 1000.0 / 1000);

    printf("ecdsa_verify: monte carlo 1K\n");
    clock_gettime(CLOCK_REALTIME, &start);
    for (int i = 0; i < 1000; i++) {
        expect(!ecdsa_verify(rs[i], ss[i], hash32, pubkeys[i]));
    }
    printf("Avg time: %f ms\n", (secs_since(&start)) * 1000.0 / 1000);


    printf("[SUCCESS] All tests passed\n");

    return 0;
}